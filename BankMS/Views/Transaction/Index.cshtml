@model IEnumerable<BankMS.Models.Transaction>
@{
    ViewData["Title"] = "Transaction History";
    ViewData["ActivePage"] = "TransactionHistory"; // For sidebar active state
}

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-5">
    <div>
        <h3 class="mb-1 fw-bold text-primary">Transaction History</h3>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a asp-controller="Dashboard" asp-action="Index">Dashboard</a></li>
                <li class="breadcrumb-item active" aria-current="page">Transaction History</li>
            </ol>
        </nav>
    </div>
    <a asp-action="CreateOrEdit" class="btn btn-success shadow-sm btn-lg">
        <i class="bi bi-plus-circle me-2"></i>New Transaction
    </a>
</div>

<!-- Filters & Search -->
<div class="dashboard-card p-4 mb-4">
    <div class="row g-3 align-items-center">
        <div class="col-lg-5">
            <div class="search-input-wrapper position-relative">
                <i class="bi bi-search position-absolute top-50 start-3 translate-middle-y text-muted"></i>
                <input type="text" id="searchInput" class="form-control ps-5" placeholder="Search by ID, account, reference, or type..." />
            </div>
        </div>
        <div class="col-lg-3">
            <select id="typeFilter" class="form-select form-select-lg">
                <option value="">All Transaction Types</option>
                <option value="Deposit">Deposit</option>
                <option value="Withdrawal">Withdrawal</option>
                <option value="Transfer">Transfer</option>
                <option value="Credit">Credit</option>
                <option value="Debit">Debit</option>
                <option value="Fee">Fee</option>
            </select>
        </div>
        <div class="col-lg-4 text-lg-end">
            <small class="text-muted" id="resultsCount">
                Showing <strong><span id="visibleCount">@Model.Count()</span></strong> of <strong>@Model.Count()</strong> transactions
            </small>
        </div>
    </div>
</div>

<!-- Transactions Table -->
<div class="data-table shadow-sm">
    <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle" id="transactionsTable">
            <thead class="bg-primary text-white">
                <tr>
                    <th class="fw-semibold">#</th>
                    <th class="fw-semibold">Transaction ID</th>
                    <th class="fw-semibold">Account Number</th>
                    <th class="fw-semibold">Type</th>
                    <th class="fw-semibold text-end">Amount</th>
                    <th class="fw-semibold">Date & Time</th>
                    <th class="fw-semibold">Reference</th>
                    <th class="fw-semibold text-center">Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                @{
                    int index = 1;
                    foreach (var transaction in Model)
                    {
                        var badgeClass = transaction.TransactionType switch
                        {
                            "Deposit" or "Credit" => "bg-success",
                            "Withdrawal" or "Debit" or "Fee" => "bg-danger",
                            "Transfer" => "bg-info text-dark",
                            _ => "bg-secondary"
                        };

                        var amountClass = transaction.Amount > 0 ? "text-success" : "text-danger";
                        var amountSign = transaction.Amount > 0 ? "+" : "";
                        <tr data-type="@transaction.TransactionType">
                            <td class="fw-medium index text-muted">@index</td>
                            <td class="fw-semibold">@transaction.Id</td>
                            <td>@transaction.AccountId</td>
                            <td>
                                <span class="badge @badgeClass px-3 py-2 rounded-pill fw-medium">@transaction.TransactionType</span>
                            </td>
                            <td class="text-end fw-bold @amountClass">
                                @amountSign@transaction.Amount.ToString("C")
                            </td>
                            <td class="text-muted">@transaction.TransactionDate.ToString("MMM dd, yyyy HH:mm")</td>
                            <td class="text-truncate" style="max-width: 200px;" title="@(transaction.Reference ?? "-")">
                                @(string.IsNullOrEmpty(transaction.Reference) ? "-" : transaction.Reference)
                            </td>
                            <td>
                                <div class="d-flex justify-content-center gap-2">
                                    <a asp-action="Details" asp-route-id="@transaction.Id"
                                       class="btn btn-info btn-sm shadow-sm"
                                       title="View Details"
                                       aria-label="View transaction details">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a asp-action="CreateOrEdit" asp-route-id="@transaction.Id"
                                       class="btn btn-warning btn-sm shadow-sm"
                                       title="Edit"
                                       aria-label="Edit transaction">
                                        <i class="bi bi-pencil-square"></i>
                                    </a>
                                    <form asp-action="Delete" asp-route-id="@transaction.Id" method="post" class="d-inline"
                                          onsubmit="return confirm('Are you sure you want to delete this transaction? This action cannot be undone.');">
                                        <button type="submit"
                                                class="btn btn-danger btn-sm shadow-sm"
                                                title="Delete"
                                                aria-label="Delete transaction">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        index++;
                    }
                }

                @if (!Model.Any())
                {
                    <tr id="emptyRow">
                        <td colspan="8" class="text-center py-6">
                            <div class="py-5">
                                <i class="bi bi-receipt fs-1 text-muted d-block mb-4"></i>
                                <h5 class="text-muted fw-medium">No transactions found</h5>
                                <p class="text-muted">There are currently no transactions to display.</p>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center p-4 border-top bg-light">
        <small class="text-muted mb-2 mb-md-0" id="pageInfo">Page 1 of 1</small>
        <nav aria-label="Transaction pagination">
            <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
        </nav>
    </div>
</div>

@section Scripts {
    <script>
        const tableBody = document.getElementById('tableBody');
        const rows = Array.from(tableBody.querySelectorAll('tr:not(#emptyRow)'));
        const emptyRow = document.getElementById('emptyRow');
        const searchInput = document.getElementById('searchInput');
        const typeFilter = document.getElementById('typeFilter');
        const visibleCount = document.getElementById('visibleCount');
        const pageInfo = document.getElementById('pageInfo');
        const pagination = document.getElementById('pagination');
        const itemsPerPage = 10;
        let currentPage = 1;

        function filterAndPaginate() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const selectedType = typeFilter.value.toLowerCase();

            let filteredRows = rows.filter(row => {
                const id = row.cells[1].textContent.toLowerCase();
                const account = row.cells[2].textContent.toLowerCase();
                const type = row.dataset.type.toLowerCase();
                const reference = row.cells[6].textContent.toLowerCase();

                const matchesSearch = id.includes(searchTerm) ||
                                      account.includes(searchTerm) ||
                                      type.includes(searchTerm) ||
                                      reference.includes(searchTerm);

                const matchesType = selectedType === '' || type === selectedType;
                return matchesSearch && matchesType;
            });

            visibleCount.textContent = filteredRows.length;
            rows.forEach(r => r.style.display = 'none');
            if (emptyRow) emptyRow.style.display = filteredRows.length === 0 ? '' : 'none';

            const totalPages = Math.max(1, Math.ceil(filteredRows.length / itemsPerPage));
            currentPage = Math.min(currentPage, totalPages);

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageRows = filteredRows.slice(start, end);

            pageRows.forEach(row => row.style.display = '');
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

            // Update serial numbers
            pageRows.forEach((row, i) => {
                row.querySelector('.index').textContent = start + i + 1;
            });

            // Build pagination
            pagination.innerHTML = '';
            if (totalPages <= 1) return;

            // Previous
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = '<a class="page-link" href="#" tabindex="-1">Previous</a>';
            if (currentPage > 1) {
                prevLi.addEventListener('click', (e) => { e.preventDefault(); currentPage--; filterAndPaginate(); });
            }
            pagination.appendChild(prevLi);

            // Pages with smart ellipsis
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || Math.abs(i - currentPage) <= 2) {
                    const li = document.createElement('li');
                    li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                    li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                    if (i !== currentPage) {
                        li.addEventListener('click', (e) => { e.preventDefault(); currentPage = i; filterAndPaginate(); });
                    }
                    pagination.appendChild(li);
                } else if (i === 2 || i === totalPages - 1) {
                    const dots = document.createElement('li');
                    dots.className = 'page-item disabled';
                    dots.innerHTML = '<a class="page-link">...</a>';
                    pagination.appendChild(dots);
                    i = i === 2 ? currentPage - 3 : currentPage + 3; // Skip ahead
                }
            }

            // Next
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = '<a class="page-link" href="#">Next</a>';
            if (currentPage < totalPages) {
                nextLi.addEventListener('click', (e) => { e.preventDefault(); currentPage++; filterAndPaginate(); });
            }
            pagination.appendChild(nextLi);
        }

        // Event listeners
        searchInput.addEventListener('input', () => { currentPage = 1; filterAndPaginate(); });
        typeFilter.addEventListener('change', () => { currentPage = 1; filterAndPaginate(); });

        // Initial render
        filterAndPaginate();
    </script>
}

<style>
    .badge {
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .table thead {
        background-color: var(--bs-primary);
        color: white;
    }

    .table th {
        border: none;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .table-hover tbody tr:hover {
        background-color: #f8f9fa !important;
        transition: background-color 0.2s ease;
    }

    .btn-sm {
        border-radius: 8px;
        padding: 0.375rem 0.65rem;
    }

    .data-table {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid #e9ecef;
    }

    .dashboard-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
        border: 1px solid #e9ecef;
    }

    .search-input-wrapper input {
        border-radius: 12px;
        padding-left: 2.5rem;
        height: 48px;
    }

    .search-input-wrapper i {
        z-index: 5;
        font-size: 1.1rem;
    }
</style>